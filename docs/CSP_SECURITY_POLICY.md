# Content Security Policy (CSP) Implementation

**Updated:** 2026-02-17
**Status:** Phase 1 Complete - Medium Security (6.5/10)

---

## Overview

The application implements a Content Security Policy to defend against:
- **XSS (Cross-Site Scripting)** - Injection of malicious scripts
- **CSS Injection** - Stylesheet-based attacks
- **Data Exfiltration** - Unauthorized data access via third-party scripts
- **Clickjacking** - Embedded iframe attacks

---

## Current CSP Policy

```
default-src 'self'
  ├─ script-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com
  ├─ style-src 'self' 'unsafe-inline'
  ├─ img-src 'self' data: blob: https:
  ├─ font-src 'self' data:
  ├─ connect-src 'self' https://*.supabase.co wss://*.supabase.co https://maps.googleapis.com ...
  ├─ worker-src 'self' blob: https://cdn.jsdelivr.net https://cdnjs.cloudflare.com
  ├─ frame-ancestors 'none'
  ├─ base-uri 'self'
  └─ form-action 'self'
```

---

## Security Improvements (Feb 2026)

### ✅ Removed Dangerous Directives

#### Before (C-2 CRITICAL Issue)
```
script-src 'self' 'unsafe-inline' 'unsafe-eval' ...
style-src 'self' 'unsafe-inline'
```

#### After (Current - Fixed)
```
script-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com
style-src 'self' 'unsafe-inline'
```

**Changes:**
1. ✅ **Removed `'unsafe-eval'`**
   - **Was:** Allowed `eval()`, `Function()`, `setTimeout(string)`, etc.
   - **Impact:** Complete removal - not used anywhere in codebase
   - **Security gain:** Eliminates entire class of dynamic code execution attacks

2. ✅ **Removed `'unsafe-inline'` from scripts**
   - **Was:** Allowed inline `<script>` tags without restrictions
   - **Impact:** Most modern bundlers (including Next.js 16) don't require it
   - **Security gain:** Prevents XSS via inline script injection
   - **How:** Next.js ships JavaScript as external files, not inline

3. ⏳ **Kept `'unsafe-inline'` for styles** (pragmatic)
   - **Reason:** 66 inline style usages in codebase (11 files)
   - **Risk:** Medium - CSS-based attacks are less critical than script injection
   - **Roadmap:** Plan gradual migration to Tailwind (see Section 4)

---

## Policy Breakdown

### directive: `default-src 'self'`
**Default fallback for all unspecified directives**
- Scripts, styles, fonts, images must come from same origin
- Provides safe baseline

### directive: `script-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com`
**Where JavaScript can be loaded**
- ✅ `'self'` - Own application scripts (Next.js bundles)
- ✅ `https://cdn.jsdelivr.net` - Frontend libraries (e.g., Recharts, date-fns)
- ✅ `https://cdnjs.cloudflare.com` - CDN fallback
- ❌ No `'unsafe-inline'` - Inline scripts must be external files
- ❌ No `'unsafe-eval'` - Dynamic code execution not allowed

**XSS Protection Level:** ⭐⭐⭐ High
- Script injection attacks fail because malicious inline scripts are blocked
- Attacker must trick app into loading script from allowed CDNs

### directive: `style-src 'self' 'unsafe-inline'`
**Where CSS can be loaded**
- ✅ `'self'` - App's own stylesheets
- ✅ `'unsafe-inline'` - Inline `<style>` tags and `style=` attributes
- ✅ Tailwind CSS (inline utility classes)

**XSS Protection Level:** ⭐⭐ Medium
- CSS injection can't execute scripts, but can:
  - Hide UI elements
  - Overlay fake login forms
  - Exfiltrate data via CSS attribute selectors
- Phased migration to hashes/nonces planned

### directive: `img-src 'self' data: blob: https:`
**Image loading sources**
- ✅ App's own images
- ✅ `data:` URLs (base64 encoded images)
- ✅ `blob:` URLs (generated by JavaScript)
- ✅ Any HTTPS image

### directive: `connect-src`
**Where XMLHttpRequest, fetch, WebSocket can connect**
- ✅ `'self'` - Server API endpoints
- ✅ `https://*.supabase.co wss://*.supabase.co` - Supabase real-time
- ✅ `https://maps.googleapis.com` - Maps API
- ✅ External CDNs and APIs

### directive: `frame-ancestors 'none'`
**Clickjacking protection**
- ❌ Cannot be embedded in iframes anywhere
- Prevents attacks like fake login screen overlays

---

## Security Assessment

| Aspect | Score | Status | Notes |
|--------|-------|--------|-------|
| Script Injection | ⭐⭐⭐ | ✅ Strong | No inline scripts, no eval |
| CSS Injection | ⭐⭐ | ⏳ Medium | Needs nonce/hash migration |
| Data Exfiltration | ⭐⭐⭐ | ✅ Strong | Only allowed domains can connect |
| Clickjacking | ⭐⭐⭐ | ✅ Strong | `frame-ancestors 'none'` |
| **Overall** | **6.5/10** | ⏳ Good | Next: Eliminate unsafe-inline styles |

---

## Roadmap: Eliminating `'unsafe-inline'` for Styles

### Phase 2 (3-4 weeks)
Gradually migrate inline styles to Tailwind utility classes.

**Current inline style usage:**
```
66 total inline styles across 11 files:
├─ app/auth/forgot-password/page.tsx
├─ app/dashboard/layout.tsx
├─ app/dashboard/loading.tsx
├─ app/login/page.tsx
├─ lib/utils/export-report.ts  (HTML templates)
└─ ... (5 more)
```

**Approach:**
1. Audit each inline style (identify why it's not using Tailwind)
2. Convert to Tailwind classes where possible
3. Use CSS Variables for dynamic values
4. For complex cases, use CSS modules

**Example Migration:**
```tsx
// Before (requires unsafe-inline)
<div style={{ width: `${percent}%`, color: '#FF0000' }}>

// After (no CSP exemption needed)
<div className={cn("w-full", { "text-red-600": isError })}>
```

### Phase 3 (Week 4+)
Once unsafe-inline for styles is removed, enable strict CSP with nonces:

```
style-src 'self' 'nonce-{random}' https://cdn.jsdelivr.net
script-src 'self' 'nonce-{random}' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com
```

Benefits:
- ✅ Only specific inline elements allowed
- ✅ Nonce regenerates per request
- ✅ Highest security level: **9/10**

---

## How to Verify CSP is Working

### Browser DevTools
```
1. Open Chrome DevTools (F12)
2. Go to Network tab
3. Look for security warnings in console
4. Check Response headers → Content-Security-Policy
```

### CSP Violations
```javascript
// This will be blocked and logged:
<script>alert('XSS attempt')</script>
// Console: "Refused to execute inline script. CSP policy..."

// This is fine (external script):
<script src="https://cdn.jsdelivr.net/npm/my-lib@1.0.0"></script>
```

### Testing CSP Violations
```bash
# Local development
pnpm dev

# Check CSP header
curl -I http://localhost:3000 | grep -i "content-security"

# Should show:
# Content-Security-Policy: default-src 'self'; script-src ...
```

---

## Potential Issues & Troubleshooting

### Issue: "Refused to execute inline script"
**Cause:** Script contains inline code execution
**Solution:**
- Move code to external .ts/.js file
- Or import and execute via Next.js

### Issue: "Blocked by CSP: image from blob: not allowed"
**Cause:** `img-src` missing `blob:`
**Solution:** Already included - should work

### Issue: "Third-party library not loading"
**Cause:** Library's CDN not in allowlist
**Solution:**
1. Identify the CDN domain
2. Add to appropriate `connect-src` or `script-src`
3. Test thoroughly
4. Document in this file

---

## Audit Log

**2026-02-17 - Phase 1: Dangerous Directives Removed**
- ✅ Removed `'unsafe-eval'` from script-src
- ✅ Removed `'unsafe-inline'` from script-src
- ✅ Kept `'unsafe-inline'` for style-src (Phase 2 work)
- ✅ Build tested successfully
- ✅ No breaking changes

**Pending - Phase 2 & 3:**
- ⏳ Migrate 66 inline styles to Tailwind
- ⏳ Implement nonce-based CSP for styles
- ⏳ Target security score: 9/10

---

## References

- [MDN: Content Security Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP)
- [CSP Evaluator](https://csp-evaluator.withgoogle.com/) - Test your policy
- [OWASP CSP Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Content_Security_Policy_Cheat_Sheet.html)
- [Next.js Security Best Practices](https://nextjs.org/docs/advanced-features/security-headers)

---

## Questions?

Refer to:
- `SECURITY.md` - Overall security guide
- `SECURITY_AUDIT_ACTION_PLAN.md` - Vulnerability remediation roadmap
